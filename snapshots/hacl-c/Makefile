.PHONY: test clean

TWEETNACL_HOME   ?=../../other_providers/tweetnacl
OPENSSL_HOME   ?=../../other_providers/openssl
LIBSODIUM_HOME ?=../../other_providers/libsodium/src/libsodium

CCOPTS = -Ofast -march=native -mtune=native  -fwrapv -fomit-frame-pointer -funroll-all-loops -g
CFLAGS ?= $(CCOPTS)
CC ?= gcc-6 -flto --param max-unroll-times=20
#CC=/usr/local/opt/llvm/bin/clang -flto

riot: riot-lib

riot-lib:
	$(CC) $(CFLAGS) -Wno-unused-parameter -Wno-shift-op-parentheses kremlib.c -c -o kremlib.o
	$(CC) $(CFLAGS) -Wno-unused-parameter -Wno-shift-op-parentheses testlib.c -c -o testlib.o
	$(CC) $(CFLAGS) -Wno-unused-parameter -Wno-shift-op-parentheses Chacha20.c -c -o Chacha20.o
	$(CC) $(CFLAGS) -Wno-unused-parameter -Wno-shift-op-parentheses Curve25519.c -c -o Curve25519.o
	ar rcs hacl.a kremlib.o testlib.o Chacha20.o Curve25519.o

test: test-poly	test-chacha test-salsa test-curve test-secretbox test-box test-aead

test-poly:
	$(CC) $(CCOPTS) \
	-I $(OPENSSL_HOME)/crypto/include -I $(OPENSSL_HOME)/crypto/poly1305 \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	kremlib.c testlib.c Poly1305_64.c test-poly.c -o test-poly.exe \
	-lsodium $(OPENSSL_HOME)/libcrypto.a
	./test-poly.exe

test-poly32-custom:
	$(CC) -Ofast -m32 -mtune=generic -fwrapv -fomit-frame-pointer -funroll-loops -fmath-errno \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	kremlib.c testlib.c Poly1305_32_custom.c test-poly32-custom.c -o test-poly32-custom.exe 
	./test-poly32-custom.exe

test-poly32:
	$(CC) -Ofast -m32 -mtune=generic -fwrapv -fomit-frame-pointer -funroll-loops -fmath-errno \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	kremlib.c testlib.c Poly1305_32.c test-poly32.c -o test-poly32.exe 
	./test-poly32.exe

test-poly-vec:
	$(CC) $(CCOPTS) \
	-I $(OPENSSL_HOME)/crypto/include -I $(OPENSSL_HOME)/crypto/poly1305 \
	kremlib.c testlib.c Poly1305_vec.c test-poly-vec.c -o test-poly-vec.exe \
	-lsodium $(OPENSSL_HOME)/libcrypto.a
	./test-poly-vec.exe

test-salsa:
	$(CC) $(CCOPTS) \
	Salsa20.c -c -o Salsa20.o
	$(CC) $(CCOPTS) \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	kremlib.c testlib.c Salsa20.o test-salsa.c -l sodium -o test-salsa.exe 
	./test-salsa.exe

test-chacha:
	$(CC) $(CCOPTS) \
	-I $(OPENSSL_HOME)/include -I $(OPENSSL_HOME)/crypto/poly1305 -I ../../other_providers/tweetnacl \
	../../other_providers/tweetnacl/tweetnacl.c kremlib.c testlib.c Chacha20.c test-chacha.c -o test-chacha.exe
	./test-chacha.exe

test-chacha-solo:
	$(CC) $(CCOPTS) \
	-I $(OPENSSL_HOME)/include -I $(OPENSSL_HOME)/crypto/poly1305 kremlib.c testlib.c Chacha20.c test-chacha.c -o test-chacha.exe
	./test-chacha.exe

test-chacha-vec:
	$(CC) $(CCOPTS) \
	-I $(OPENSSL_HOME)/include -I $(OPENSSL_HOME)/crypto/poly1305 -I ../../other_providers/tweetnacl \
	../../other_providers/tweetnacl/tweetnacl.c kremlib.c testlib.c Chacha20_vec.c test-chacha20-vec.c -o test-chacha-vec.exe \
	 $(OPENSSL_HOME)/libcrypto.a -l sodium -lpthread -ldl
	./test-chacha-vec.exe

test-curve:
	$(CC) $(CCOPTS) \
	-I $(OPENSSL_HOME) -I $(OPENSSL_HOME)/include -I $(OPENSSL_HOME)/crypto/ec \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c -L ../../other_providers/libsodium \
	kremlib.c testlib.c Curve25519.c test-curve.c -o test-curve.exe \
	$(OPENSSL_HOME)/libcrypto.a $(OPENSSL_HOME)/libssl.a -lsodium -lpthread -ldl
	./test-curve.exe

test-curve32-custom:
	$(CC) -Ofast -mtune=generic -m32 -fwrapv -fomit-frame-pointer -funroll-loops -std=c11 -fmath-errno \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c curve25519-donna.c \
	kremlib.c testlib.c Curve25519_32_custom.c test-curve32-custom.c -o test-curve32-custom.exe 
	./test-curve32-custom.exe

test-secretbox:
	$(CC) $(CCOPTS) \
	HSalsa20.c -c -o HSalsa20.o
	$(CC) $(CCOPTS) \
	Salsa20.c -c -o Salsa20.o
	$(CC) $(CCOPTS) \
	Poly1305_64.c -c -o Poly1305_64.o
	$(CC) $(CCOPTS) \
	Curve25519.c -c -o Curve25519.o
	$(CC) $(CCOPTS) \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	HSalsa20.o Salsa20.o Poly1305_64.o Curve25519.o kremlib.c testlib.c Hacl_Policies.c NaCl.c test-secretbox.c -l sodium -o test-secretbox.exe
	./test-secretbox.exe

test-aead:
	$(CC) $(CCOPTS) \
	Chacha20.c -c -o Chacha20.o
	$(CC) $(CCOPTS) \
	Poly1305_64.c -c -o Poly1305_64.o
	$(CC) $(CCOPTS) \
	Chacha20.o Poly1305_64.o kremlib.c testlib.c Hacl_Policies.c Chacha20Poly1305.c test-aead.c -o test-aead.exe \
	-l sodium  $(OPENSSL_HOME)/libcrypto.a $(OPENSSL_HOME)/libssl.a -lpthread -ldl
	./test-aead.exe

test-box:
	$(CC) $(CCOPTS) \
	HSalsa20.c -c -o HSalsa20.o
	$(CC) $(CCOPTS) \
	Salsa20.c -c -o Salsa20.o
	$(CC) $(CCOPTS) \
	Poly1305_64.c -c -o Poly1305_64.o
	$(CC) $(CCOPTS) \
	Curve25519.c -c -o Curve25519.o
	$(CC) $(CCOPTS) \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	HSalsa20.o Salsa20.o Poly1305_64.o Curve25519.o kremlib.c testlib.c Hacl_Policies.c NaCl.c test-box.c -l sodium -o test-box.exe
	./test-box.exe

lib:
	$(CC) $(CCOPTS) \
	HSalsa20.c -c -o HSalsa20.o
	$(CC) $(CCOPTS) \
	Salsa20.c -c -o Salsa20.o
	$(CC) $(CCOPTS) \
	Poly1305_64.c -c -o Poly1305_64.o
	$(CC) $(CCOPTS) \
	Curve25519.c -c -o Curve25519.o
	$(CC) $(CCOPTS) \
	Chacha20Poly1305.c -c -o Chacha20Poly1305.o
	$(CC) -shared  $(CCOPTS) \
	HSalsa20.o Salsa20.o Poly1305_64.o Chacha20.o Chacha20Poly1305.o Curve25519.o kremlib.c Hacl_Policies.c NaCl.c \
	-o libhacl.so

lib-test: lib
	$(CC)  $(CCOPTS) \
	-I $(OPENSSL_HOME)/crypto/include -I $(OPENSSL_HOME)/crypto/poly1305 \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	testlib.c test-poly.c -o test-poly.exe \
	-lsodium $(OPENSSL_HOME)/libcrypto.a libhacl.so
	$(CC)  $(CCOPTS) \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	testlib.c test-salsa.c -o test-salsa.exe \
	-lsodium $(OPENSSL_HOME)/libcrypto.a libhacl.so
	$(CC)  $(CCOPTS) \
	-I $(OPENSSL_HOME)/include -I $(OPENSSL_HOME)/crypto/poly1305 -I ../../other_providers/tweetnacl \
	../../other_providers/tweetnacl/tweetnacl.c testlib.c test-chacha.c -o test-chacha.exe \
	 $(OPENSSL_HOME)/libcrypto.a -l sodium -lpthread -ldl libhacl.so
	$(CC)  $(CCOPTS) \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	testlib.c test-secretbox.c -o test-secretbox.exe \
	-lsodium $(OPENSSL_HOME)/libcrypto.a libhacl.so
	$(CC)  $(CCOPTS) \
	testlib.c test-aead.c -o test-aead.exe \
	-l sodium  $(OPENSSL_HOME)/libcrypto.a $(OPENSSL_HOME)/libssl.a -lpthread -ldl libhacl.so
	$(CC)  $(CCOPTS) \
	-I $(OPENSSL_HOME) -I $(OPENSSL_HOME)/include -I $(OPENSSL_HOME)/crypto/ec \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	testlib.c test-curve.c -o test-curve.exe \
	$(OPENSSL_HOME)/libcrypto.a $(OPENSSL_HOME)/libssl.a -l sodium -lpthread -ldl libhacl.so
	$(CC)  $(CCOPTS) \
	-I $(TWEETNACL_HOME) $(TWEETNACL_HOME)/tweetnacl.c \
	testlib.c test-box.c -o test-box.exe -l sodium  libhacl.so
	./test-chacha.exe
	./test-salsa.exe
	./test-poly.exe
	./test-secretbox.exe	
	./test-aead.exe	
	./test-curve.exe
	./test-box.exe



clean:
	rm -rf *~ *.exe *.out *.o
